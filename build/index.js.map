{"version":3,"sources":["../src/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import * as _ from 'lodash'\nimport * as parser from 'docker-file-parser'\nimport * as fs from 'fs'\n\n/**\n * TransposeOptions:\n *\tOptions to be passed to the transpose module\n */\nexport interface TransposeOptions {\n\t/**\n\t * hostQemuPath: the path of the qemu binary on the host\n\t */\n\thostQemuPath: string\n\n\t/**\n\t * containerQemuPath: Where to add the qemu binary on-container\n\t */\n\tcontainerQemuPath: string\n}\n\ntype CommandTransposer = (options: TransposeOptions, command: parser.Command) => parser.Command\n\nconst generateQemuCopy = (options: TransposeOptions): parser.Command => {\n\treturn {\n\t\tname: 'COPY',\n\t\targs: [options.hostQemuPath, options.containerQemuPath]\n\t}\n}\n\nconst transposeArrayRun = (options: TransposeOptions, command: parser.Command): parser.Command => {\n\treturn {\n\t\tname: 'RUN',\n\t\targs: [options.containerQemuPath, \"-execve\", \"/bin/sh\", \"-c\"].concat((<string[]>command.args).join(' '))\n\t}\n}\n\nconst transposeStringRun = (options: TransposeOptions, command: parser.Command): parser.Command => {\n\treturn {\n\t\tname: 'RUN',\n\t\targs: [options.containerQemuPath, \"-execve\", \"/bin/sh\", \"-c\"].concat([<string>command.args])\n\t\t// args: [options.containerQemuPath].concat((<string[]>command.args).join(' '))\n\t}\n}\n\nconst transposeRun = (options: TransposeOptions, command: parser.Command): parser.Command => {\n\tif (_.isArray(command.args)) {\n\t\treturn transposeArrayRun(options, command)\n\t}\n\treturn transposeStringRun(options, command)\n}\n\nconst identity = (options: TransposeOptions, command: parser.Command): parser.Command => {\n\treturn command\n}\n\nconst commandToTranspose = (command: parser.Command): CommandTransposer => {\n\tif (command.name == 'RUN') {\n\t\treturn transposeRun\n\t}\n\treturn identity\n}\n\nconst argsToString = (args: string | { [key: string]: string } | string[]): string => {\n\tif (_.isArray(args)) {\n\t\treturn '[\"' + args.join('\",\"') + '\"]'\n\t} else {\n\t\treturn <string>args\n\t}\n}\n\nconst commandsToDockerfile = (commands: parser.Command[]): string => {\n\tlet dockerfile = ''\n\n\tcommands.map((command) => {\n\t\tdockerfile += `${command.name} ${argsToString(command.args)}\\n`\n\t})\n\treturn dockerfile\n}\n\n/**\n * transpose:\n *\tGiven a string representing a dockerfile, transpose it to use qemu\n *\trather than native, to enable emulated builds\n *\n * @param dockerfile\n *\tA string representing the dockerfile\n * @param options\n *\tOPtions to use when doing the transposing\n */\nexport function transpose(dockerfile: string, options: TransposeOptions): string {\n\tlet output = ''\n\n\t// parse the Dokerfile\n\tconst commands = parser.parse(dockerfile, { includeComments: false })\n\n\tconst firstRunIdx = _.findIndex(commands, (command) => command.name == 'RUN')\n\n\tlet outCommands = commands.slice(0, firstRunIdx)\n\n\toutCommands.push(generateQemuCopy(options))\n\n\n\toutCommands = outCommands.concat(\n\t\tcommands.slice(firstRunIdx).map(\n\t\t\t(command) => commandToTranspose(command)(options, command)\n\t\t)\n\t)\n\n\treturn commandsToDockerfile(outCommands)\n}\n\n\nconst dockerfile = transpose(fs.readFileSync('Dockerfile.unemu').toString(), { hostQemuPath: 'qemu-arm', containerQemuPath: '/usr/local/bin/qemu' })\nconsole.log(dockerfile)\n"],"sourceRoot":"src"}